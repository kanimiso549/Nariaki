import discord
from discord import app_commands
from discord.ext import commands
import random

TARGET_CHANNEL_ID = 1404482743273918595
ALLOWED_ROLE_ID = 1084660531559944302

MEDIA_EXTENSIONS = [
    ".png", ".jpg", ".jpeg", ".gif", ".webp",
    ".mp4", ".mov", ".webm", ".mkv"
]

def has_allowed_role(interaction: discord.Interaction) -> bool:
    """指定ロールを持っているか確認"""
    return any(role.id == ALLOWED_ROLE_ID for role in interaction.user.roles)

class Chono(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.media_file_cache = []

    async def fetch_media_files(self):
        channel = self.bot.get_channel(TARGET_CHANNEL_ID)
        if not channel:
            print("❌ チャンネルが見つかりません")
            return
        self.media_file_cache.clear()
        try:
            async for msg in channel.history(limit=200):
                for attachment in msg.attachments:
                    filename = attachment.filename.lower()
                    if any(filename.endswith(ext) for ext in MEDIA_EXTENSIONS):
                        self.media_file_cache.append(attachment)
            print(f"🎞️ メディアファイル {len(self.media_file_cache)} 件をキャッシュしました。")
        except Exception as e:
            print(f"❌ メディア取得エラー: {e}")

    @app_commands.command(name="chono", description="コマンド実行者は蝶野正洋必ずもらえる！")
    @app_commands.check(has_allowed_role)
    async def random_media(self, interaction: discord.Interaction):
        if not self.media_file_cache:
            await self.fetch_media_files()
        if not self.media_file_cache:
            await interaction.response.send_message("⚠️ メディアファイルが見つかりません。", ephemeral=True)
            return
        media = random.choice(self.media_file_cache)
        try:
            await interaction.response.send_message(file=await media.to_file())
        except Exception as e:
            await interaction.response.send_message(f"❌ 送信エラー: {e}", ephemeral=True)

    @app_commands.command(name="reloadfiles_chono", description="蝶野正洋のメディアファイルを再読み込みします")
    @app_commands.check(has_allowed_role)
    async def reload_files(self, interaction: discord.Interaction):
        await self.fetch_media_files()
        await interaction.response.send_message("🔄 メディアファイルを再読み込みしました。", ephemeral=True)

    @random_media.error
    @reload_files.error
    async def on_app_command_error(self, interaction: discord.Interaction, error):
        if isinstance(error, app_commands.CheckFailure):
            await interaction.response.send_message("🚫 あなたにはこのコマンドを使う権限がありません。", ephemeral=True)
        else:
            raise error

async def setup(bot: commands.Bot):
    cog = Chono(bot)
    await cog.fetch_media_files()
    await bot.add_cog(cog)
